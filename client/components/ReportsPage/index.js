import React, { useEffect } from 'react'
import { useDispatch, useSelector } from 'react-redux'
import RawReports from 'Components/ReportsPage/RawReports'
import Reports from 'Components/ReportsPage/Reports'
import SisReports from 'Components/ReportsPage/SisReports'
import EnrolmentLimbo from 'Components/ReportsPage/EnrolmentLimbo'
import {
  getAllReportsAction
} from 'Utilities/redux/reportsReducer'
import {
  sisGetAllReportsAction,
  sisGetUsersReportsAction
} from 'Utilities/redux/sisReportsReducer'
import { Menu, Icon, Tab } from 'semantic-ui-react'
import { getAllCoursesAction, getUsersCoursesAction } from '../../utils/redux/coursesReducer'

export default () => {
  const dispatch = useDispatch()
  const user = useSelector((state) => state.user.data)
  const reports = useSelector((state) => state.reports)
  const sisReports = useSelector((state) => state.sisReports)

  useEffect(() => {
    if (user.adminMode) {
      dispatch(getAllCoursesAction())
      dispatch(sisGetAllReportsAction())
    } else {
      dispatch(sisGetUsersReportsAction(user.id))
      dispatch(getUsersCoursesAction(user.id))
    }
  }, [user])

  const handleTabChange = (_, { activeIndex }) => {
    // Fetch old reports only if tab is opened
    if (user.adminMode && activeIndex > 2)
      dispatch(getAllReportsAction())
  }

  let panes = [
    {
      menuItem: (
        <Menu.Item key="sis-manual" data-cy="sis-reports-tab">
          <Icon name="file alternate" />
          SIS Reports
        </Menu.Item>
      ),
      render: () => (
        <Tab.Pane loading={sisReports ? sisReports.pending : true}>
          <SisReports
            user={user}
            reports={sisReports.data.filter((entry) => entry.reporterId)}
          />
        </Tab.Pane>
      )
    }
  ]

  if (user.adminMode) {
    panes = [...panes, {
      menuItem: (
        <Menu.Item key="sis-mooc" data-cy="sis-auto-reports-tab">
          <Icon name="file alternate" />
          SIS Autogenerated Reports
        </Menu.Item>
      ),
      render: () => (
        <Tab.Pane loading={sisReports ? sisReports.pending : true}>
          <SisReports
            user={user}
            reports={sisReports.data.filter((entry) => !entry.reporterId)}
          />
        </Tab.Pane>
      )
    },
    {
      menuItem: (
        <Menu.Item key="sis-limbo" data-cy="sis-limbo">
          <Icon name="sync" />
          Enrolment limbo
        </Menu.Item>
      ),
      render: () => (
        <Tab.Pane loading={sisReports ? sisReports.pending : true}>
          <EnrolmentLimbo
            rawEntries={sisReports.data.filter((rawEntry) => rawEntry.entry.missingEnrolment)}
          />
        </Tab.Pane>
      )
    },
    {
      menuItem: (
        <Menu.Item key="mooc" data-cy="mooc-reports-tab">
          <Icon name="file alternate outline" />
          Autogenerated MOOC (OODI)
        </Menu.Item>
      ),
      render: () => (
        <Tab.Pane>
          <RawReports
            reports={{
              ...reports,
              data: reports.data.filter((report) => !report.reporterId)
            }}
          />
        </Tab.Pane>
      )
    },
    {
      menuItem: (
        <Menu.Item key="pretty" data-cy="pretty-reports-tab">
          <Icon name="tasks" />
          Pretty (OODI)
        </Menu.Item>
      ),
      render: () => (
        <Tab.Pane>
          <Reports />
        </Tab.Pane>
      )
    },
    {
      menuItem: (
        <Menu.Item key="raw" data-cy="raw-reports-tab">
          <Icon name="file alternate outline" />
          Raw (OODI)
        </Menu.Item>
      ),
      render: () => (
        <Tab.Pane>
          <RawReports
            reports={{
              ...reports,
              data: reports.data.filter((report) => report.reporterId)
            }}
          />
        </Tab.Pane>
      )
    }
    ]
  }

  return <Tab panes={panes} onTabChange={handleTabChange} />
}
